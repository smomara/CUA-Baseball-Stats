<!DOCTYPE html>
<html>

  <head>
    <meta charset="UTF-8">
    <title>D3 T25 Scoreboard</title>
    <link rel="stylesheet" href="./style.css">
  </head>

  <body>
    <h1>DIII Top 25 Scoreboard</h1>
    <p><a href="../"><u>Home</u></a></p>
    <table id="games-table">
    <thead>
      <tr>
        <th></th>
        <th>Home</th>
        <th>Away</th>
        <th>Score</th>
      </tr>
    </thead>
    </table>
    <script>
      const https = require('https');
      const cheerio = require('cheerio');

      const options = {
        hostname: 'www.d3baseball.com',
        path: '/seasons/2023/schedule/',
        headers: {
          'User-Agent': 'Mozilla/5.0'
        }
      };

      https.get(options, (res) => {
            let data = '';

            res.on('data', (chunk) => {
              data += chunk;
            });

            res.on('end', () => {
                  const $ = cheerio.load(data);
                  const games = [];
                  let count = 0;
                  let index = -1;
                  const table = $('tr.roster-row0').parent('table');

                  $('td', table).slice(6).each((i, el) => {
                    const curr = $(el).text().trim();
                    if (count % 7 === 0) {
                      index++;
                      games.push([]);
                    }
                    games[index].push(curr.split('\n').map((item) => item.trim()));
                    count++;
                  });

                  for (let i = 0; i < games.length; i++) {
                    games[i] = games[i].flat();
                  }

                  const ttf_games = [];
                  index = -1;

                  for (const game of games) {
                    if (game[0].startsWith('No.') || game[6].startsWith('No.')) {
                      ttf_games.push([game[0], game[1], game[4], game[6], game[7], game[10], game[12]]);
                    }
                  }

                  for (const game of ttf_games) {
                    if (game[0].length > 0) {
                      game[0] = game[0].trim().split(' ')[1] + ' ';
                    }

                    if (game[3].length > 0) {
                      game[3] = game[3].trim().split(' ')[1] + ' ';
                    }

                    if (game[6].trim().split(' ').length > 2) {
                      if (game[6].trim().split(' ')[0] === 'Bottom') {
                        game[6] = `Bot ${game[6].trim().split(' ')[2].slice(0, -2)}`;
                      } else if (game[6].trim().split(' ')[0] === 'Top') {
                        game[6] = `Top ${game[6].trim().split(' ')[2].slice(0, -2)}`;
                      }
                    }
                  }

                  function sort_key(subarr) {
                    const last_elem = subarr[subarr.length - 1];
                    if (last_elem.startsWith('Bot')) {
                      return [0, parseInt(last_elem.split(' ')[1])];
                    } else if (last_elem.startsWith('Top')) {
                      return [1, parseInt(last_elem.split(' ')[1])];
                    } else if (last_elem.startsWith('Final')) {
                      return [2];
                    } else if (last_elem.includes(':')) {
                      return [3, last_elem];
                    } else if (last_elem === 'Cancelled' || last_elem === 'Postponed') {
                      return [4];
                    } else {
                      return [5];
                    }
                  }

                  const sorted_games = ttf_games.sort((a, b) => {
                    const key_a = sort_key(a);
                    const key_b = sort_key(b);

                    if (key_a < key_b) {
                      return -1;
                    } else if (key_a > key_b) {
                      return 1;
                    } else {
                      return 0;
                    }
                  });

                  const table = document.getElementById("games-table");
                  sorted_games.forEach(game => {
                    const row = table.insertRow(-1);

                    const no_cell = row.insertCell(0);
                    no_cell.innerHTML = game[0];

                    const team_cell = row.insertCell(1);
                    team_cell.innerHTML = game[1];

                    const at_cell = row.insertCell(2);
                    at_cell.innerHTML = "@";

                    const opp_cell = row.insertCell(3);
                    opp_cell.innerHTML = game[3];

                    const date_cell = row.insertCell(4);
                    if (game[2] !== "") {
                      date_cell.innerHTML = game[2];
                    }

                    const time_cell = row.insertCell(5);
                    if (game[5] !== "") {
                      time_cell.innerHTML = game[5];
                    } else {
                      time_cell.innerHTML = game[6];
                    }
                  });

    </script>
  </body>

</html>
